{"version":3,"sources":["../../src/service/auth.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from './prisma.service';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport { InjectRedis } from '@nestjs-modules/ioredis';\r\nimport IoRedis from 'ioredis';\r\nimport { Response } from 'express';\r\nimport axios from 'axios';\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  constructor(\r\n    private readonly prisma: PrismaService,\r\n    private readonly jwtService: JwtService,\r\n    @InjectRedis() private readonly redis: IoRedis,\r\n  ) {}\r\n  async signIn(loginParam: any, res: Response) {\r\n    const { email } = loginParam;\r\n    const user = await this.prisma.user.create({\r\n      data: {\r\n        email,\r\n      },\r\n    });\r\n    const payload = { sub: user.id };\r\n    const access_token = await this.jwtService.signAsync(payload, {\r\n      secret: process.env.ACCESS_TOKEN_SECRET,\r\n    });\r\n    this.redis\r\n      .multi()\r\n      .set(`userId:${user.id}`, access_token)\r\n      .expire(`userId:${user.id}`, 60 * 60 * 24 * 3)\r\n      .exec();\r\n    res.cookie('userId', user.id, {\r\n      httpOnly: true,\r\n      maxAge: 1000 * 60 * 60 * 24 * 3,\r\n    });\r\n    res.send({\r\n      status: 200,\r\n      message: '登录成功',\r\n    });\r\n  }\r\n\r\n  async oauthRedirect(code: string, res: Response) {\r\n    console.log(code);\r\n\r\n    const tokenResponse = await axios({\r\n      method: 'post',\r\n      url:\r\n        'https://github.com/login/oauth/access_token?' +\r\n        `client_id=${'Ov23li9D4HB48T32pxI9'}&` +\r\n        `client_secret=${'d192c5308379781d18d3cb48a6d0f704346bf5ab'}&` +\r\n        `code=${code}`,\r\n      headers: {\r\n        accept: 'application/json',\r\n      },\r\n    });\r\n    const accessToken = tokenResponse.data.access_token;\r\n    const result = await axios({\r\n      method: 'get',\r\n      url: `https://api.github.com/user`,\r\n      headers: {\r\n        accept: 'application/json',\r\n        Authorization: `token ${accessToken}`,\r\n      },\r\n    });\r\n    const userInfo = result.data;\r\n    const userId = result.data.id;\r\n    this.redis\r\n      .multi()\r\n      .set(`gid:${userId}`, accessToken)\r\n      .expire(`gid:${userId}`, 60 * 60 * 24 * 3)\r\n      .exec();\r\n    res.cookie('gid', userId, {\r\n      httpOnly: true,\r\n      maxAge: 1000 * 60 * 60 * 24 * 3,\r\n    });\r\n\r\n    return userInfo;\r\n  }\r\n}\r\n"],"names":["AuthService","signIn","loginParam","res","email","user","prisma","create","data","payload","sub","id","access_token","jwtService","signAsync","secret","process","env","ACCESS_TOKEN_SECRET","redis","multi","set","expire","exec","cookie","httpOnly","maxAge","send","status","message","oauthRedirect","code","console","log","tokenResponse","axios","method","url","headers","accept","accessToken","result","Authorization","userInfo","userId","constructor"],"mappings":";;;;+BASaA;;;eAAAA;;;wBATc;+BACG;qBACH;yBACC;iEACR;8DAEF;;;;;;;;;;;;;;;;;;;;AAGX,IAAA,AAAMA,cAAN,MAAMA;IAMX,MAAMC,OAAOC,UAAe,EAAEC,GAAa,EAAE;QAC3C,MAAM,EAAEC,KAAK,EAAE,GAAGF;QAClB,MAAMG,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,MAAM,CAAC;YACzCC,MAAM;gBACJJ;YACF;QACF;QACA,MAAMK,UAAU;YAAEC,KAAKL,KAAKM,EAAE;QAAC;QAC/B,MAAMC,eAAe,MAAM,IAAI,CAACC,UAAU,CAACC,SAAS,CAACL,SAAS;YAC5DM,QAAQC,QAAQC,GAAG,CAACC,mBAAmB;QACzC;QACA,IAAI,CAACC,KAAK,CACPC,KAAK,GACLC,GAAG,CAAC,CAAC,OAAO,EAAEhB,KAAKM,EAAE,EAAE,EAAEC,cACzBU,MAAM,CAAC,CAAC,OAAO,EAAEjB,KAAKM,EAAE,EAAE,EAAE,KAAK,KAAK,KAAK,GAC3CY,IAAI;QACPpB,IAAIqB,MAAM,CAAC,UAAUnB,KAAKM,EAAE,EAAE;YAC5Bc,UAAU;YACVC,QAAQ,OAAO,KAAK,KAAK,KAAK;QAChC;QACAvB,IAAIwB,IAAI,CAAC;YACPC,QAAQ;YACRC,SAAS;QACX;IACF;IAEA,MAAMC,cAAcC,IAAY,EAAE5B,GAAa,EAAE;QAC/C6B,QAAQC,GAAG,CAACF;QAEZ,MAAMG,gBAAgB,MAAMC,IAAAA,cAAK,EAAC;YAChCC,QAAQ;YACRC,KACE,iDACA,CAAC,UAAU,EAAE,uBAAuB,CAAC,CAAC,GACtC,CAAC,cAAc,EAAE,2CAA2C,CAAC,CAAC,GAC9D,CAAC,KAAK,EAAEN,MAAM;YAChBO,SAAS;gBACPC,QAAQ;YACV;QACF;QACA,MAAMC,cAAcN,cAAc1B,IAAI,CAACI,YAAY;QACnD,MAAM6B,SAAS,MAAMN,IAAAA,cAAK,EAAC;YACzBC,QAAQ;YACRC,KAAK,CAAC,2BAA2B,CAAC;YAClCC,SAAS;gBACPC,QAAQ;gBACRG,eAAe,CAAC,MAAM,EAAEF,aAAa;YACvC;QACF;QACA,MAAMG,WAAWF,OAAOjC,IAAI;QAC5B,MAAMoC,SAASH,OAAOjC,IAAI,CAACG,EAAE;QAC7B,IAAI,CAACQ,KAAK,CACPC,KAAK,GACLC,GAAG,CAAC,CAAC,IAAI,EAAEuB,QAAQ,EAAEJ,aACrBlB,MAAM,CAAC,CAAC,IAAI,EAAEsB,QAAQ,EAAE,KAAK,KAAK,KAAK,GACvCrB,IAAI;QACPpB,IAAIqB,MAAM,CAAC,OAAOoB,QAAQ;YACxBnB,UAAU;YACVC,QAAQ,OAAO,KAAK,KAAK,KAAK;QAChC;QAEA,OAAOiB;IACT;IAnEAE,YACE,AAAiBvC,MAAqB,EACtC,AAAiBO,UAAsB,EACvC,AAAgCM,KAAc,CAC9C;aAHiBb,SAAAA;aACAO,aAAAA;aACeM,QAAAA;IAC/B;AAgEL"}