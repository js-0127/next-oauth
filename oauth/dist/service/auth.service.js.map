{"version":3,"sources":["../../src/service/auth.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from './prisma.service';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport { InjectRedis } from '@nestjs-modules/ioredis';\r\nimport IoRedis from 'ioredis';\r\nimport { Response } from 'express';\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  constructor(\r\n    private readonly prisma: PrismaService,\r\n    private readonly jwtService: JwtService,\r\n    @InjectRedis() private readonly redis: IoRedis,\r\n  ) {}\r\n  async signIn(loginParam: any, res: Response) {\r\n    const { email } = loginParam;\r\n    const user = await this.prisma.user.create({\r\n      data: {\r\n        email,\r\n      },\r\n    });\r\n    const payload = { sub: user.id };\r\n    const access_token = await this.jwtService.signAsync(payload, {\r\n      secret: process.env.ACCESS_TOKEN_SECRET,\r\n    });\r\n    this.redis\r\n      .multi()\r\n      .set(`userId:${user.id}`, access_token)\r\n      .expire(`userId:${user.id}`, 60 * 60 * 24 * 3)\r\n      .exec();\r\n    res.cookie('userId', user.id, {\r\n      httpOnly: true,\r\n      maxAge: 1000 * 60 * 60 * 24 * 3,\r\n    });\r\n    res.send({\r\n      status: 200,\r\n      message: '登录成功',\r\n    });\r\n  }\r\n}\r\n"],"names":["AuthService","signIn","loginParam","res","email","user","prisma","create","data","payload","sub","id","access_token","jwtService","signAsync","secret","process","env","ACCESS_TOKEN_SECRET","redis","multi","set","expire","exec","cookie","httpOnly","maxAge","send","status","message","constructor"],"mappings":";;;;+BAQaA;;;eAAAA;;;wBARc;+BACG;qBACH;yBACC;iEACR;;;;;;;;;;;;;;;;;;;;AAIb,IAAA,AAAMA,cAAN,MAAMA;IAMX,MAAMC,OAAOC,UAAe,EAAEC,GAAa,EAAE;QAC3C,MAAM,EAAEC,KAAK,EAAE,GAAGF;QAClB,MAAMG,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,MAAM,CAAC;YACzCC,MAAM;gBACJJ;YACF;QACF;QACA,MAAMK,UAAU;YAAEC,KAAKL,KAAKM,EAAE;QAAC;QAC/B,MAAMC,eAAe,MAAM,IAAI,CAACC,UAAU,CAACC,SAAS,CAACL,SAAS;YAC5DM,QAAQC,QAAQC,GAAG,CAACC,mBAAmB;QACzC;QACA,IAAI,CAACC,KAAK,CACPC,KAAK,GACLC,GAAG,CAAC,CAAC,OAAO,EAAEhB,KAAKM,EAAE,EAAE,EAAEC,cACzBU,MAAM,CAAC,CAAC,OAAO,EAAEjB,KAAKM,EAAE,EAAE,EAAE,KAAK,KAAK,KAAK,GAC3CY,IAAI;QACPpB,IAAIqB,MAAM,CAAC,UAAUnB,KAAKM,EAAE,EAAE;YAC5Bc,UAAU;YACVC,QAAQ,OAAO,KAAK,KAAK,KAAK;QAChC;QACAvB,IAAIwB,IAAI,CAAC;YACPC,QAAQ;YACRC,SAAS;QACX;IACF;IA7BAC,YACE,AAAiBxB,MAAqB,EACtC,AAAiBO,UAAsB,EACvC,AAAgCM,KAAc,CAC9C;aAHiBb,SAAAA;aACAO,aAAAA;aACeM,QAAAA;IAC/B;AA0BL"}